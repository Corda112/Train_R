Air Pollution Analysis – Final project 

主題 1：專案背景與研究動機

1.1 空氣品質季節性預測
分析空氣污染物隨季節變化的趨勢，建立季節性預測模型。透過時間序列分解和預測技術，瞭解全年不同季節的空氣品質變化規律，例如預測冬季與夏季的污染水準差異，提供季節性趨勢的洞察。此目標有助於提前預判高污染季節來臨時的空品狀況

1.2 污染源分類
利用無監督學習將空氣品質資料進行分群，從中歸納出不同污染源型態。透過分析各測站污染物組成與特徵（例如某些地區可能以交通汙染為主、某些地區工業排放較多），將相似污染特徵歸類，達到污染源分類的目的。此目標將有助於辨識各地區主要的污染來源類別。

1.3 異常檢測
建立空氣品質異常事件的自動偵測機制，及早發現空汙異常尖峰或資料異常。透過異常檢測模型偵測出明顯偏離正常模式的事件（例如突發性污染尖峰、儀器錯誤數據），並對這些異常情境進行研判與說明。此目標可用於環境預警系統，及時識別嚴重污染事件或資料品質問題，進而分析其成因與影響。


主題 2：研究目標與範圍

2.1 研究全台AQi測站的觀測資料
時間: 2020-01-01 - 2024-12-20
站別: 全台75站
內容: 
#### 時間欄位
- **`date`**: 日期時間戳記 (YYYY-MM-DD HH:MM:SS)

#### 空氣品質指標 (AQI相關)
- **`AQI_aqi`**: 空氣品質指數 (目標變數)
- **`AQI_so2`**: 二氧化硫濃度 (ppb)
- **`AQI_co`**: 一氧化碳濃度 (ppm) 
- **`AQI_o3`**: 臭氧濃度 (ppb)
- **`AQI_o3_8hr`**: 臭氧8小時平均濃度 (ppb)
- **`AQI_pm10`**: 懸浮微粒PM10濃度 (μg/m³)
- **`AQI_pm2.5`**: 細懸浮微粒PM2.5濃度 (μg/m³)
- **`AQI_no2`**: 二氧化氮濃度 (ppb)
- **`AQI_nox`**: 氮氧化物濃度 (ppb)
- **`AQI_no`**: 一氧化氮濃度 (ppb)
- **`AQI_co_8hr`**: 一氧化碳8小時平均濃度 (ppm)
- **`AQI_pm2.5_avg`**: PM2.5移動平均 (μg/m³)
- **`AQI_pm10_avg`**: PM10移動平均 (μg/m³)
- **`AQI_so2_avg`**: SO2移動平均 (ppb)

#### 氣象資料
- **`Weather_Tx`**: 溫度 (°C)
- **`Weather_RH`**: 相對濕度 (%)
- **`Weather_WS`**: 風速 (m/s)
- **`Weather_WD`**: 風向 (度)

#### 污染物類別 (One-hot編碼)
- **`AQI_pollutant_0`**: NA值 (0/1)
- **`AQI_pollutant_1`**: 細懸浮微粒為主要污染物 (0/1)
- **`AQI_pollutant_2`**: 臭氧八小時為主要污染物 (0/1)
- **`AQI_pollutant_3`**: 懸浮微粒為主要污染物 (0/1)
- **`AQI_pollutant_4`**: 二氧化氮為主要污染物 (0/1)
- **`AQI_pollutant_5`**: 二氧化硫為主要污染物 (0/1)

#### 時間特徵 (正弦轉換)
- **`month_sin`**: 月份正弦值 (-1~1)
- **`hour_sin`**: 小時正弦值 (-1~1)  
- **`day_sin`**: 日期正弦值 (-1~1)

來源: 「空氣品質指標(AQI)歷史資料」(資料集代碼AQX_P_488) 環境資料開放平臺 data.moenv.gov.tw

2.2 藉由模型找出不同測站的汙染物與空氣品質及時間的關係

3.模型訓練

3.1 模型資料前處理

(1) 將空品資料、氣象資料、工廠資料Mapping起來，新增"空品label"、"空品站對應工廠數量"...等特徵
(2) Combined_AQI_Weather_Dataset將前一階段Mapping的空品資料以及氣象資料做結合
    ***移除琉球、樹林、麻豆、鳳山、關山，因"多種"特徵缺失高達30%以上***
(3) 某些站別因單種特徵缺失值嚴重，因此使用附近站別補充缺失
(4) 沙鹿 & 臺西的Weather_Tx、Weather_RH缺失過多，找附近的站別補(未使用的)
(5) 依照最後結果，照下面的缺失等級做不同的補值動作
          一. <6hr使用線性插植
          二. 6hr~24hr使用KNN
          三. >24hr使用同時期平均
       註：判定缺失時間的標準是在遇到第一個NA後持續向後"累積"計算
       補充:如果資料不一致訓練會需要再額外補充資料
(6) 本地有經過one-hot-encoding(針對label & AQI_Pollutant)、Add_month-day-hour(有經過正弦轉換)
    其餘20個特徵有經過偏態修正以及標準化，設定值如下：
    (1) |skew| > 2 (極度偏態) → Yeo-Johnson 變換
    (2) 1 < skew ≤ 2 (強偏態) → 對數變換
    (3) -2 ≤ skew < -1 (左強偏態) → Yeo-Johnson 變換
    (4) 0.5 < skew ≤ 1 (中度偏態) → 平方根/平方變換
    (5) -1 ≤ skew < -0.5 (左中度偏態) → Yeo-Johnson 變換
    (6) |skew| ≤ 0.5 (近似對稱) → 不動作
    (7) transform用 log1p(x) 而不是 log(x)，以免遇到 0 時出錯
    (8) 穩健標準化 (RobustScaler) => 一定先進行偏態修正再進行標準化
(7) 切分檔案
	DATA/
	├── Separate/                    # 原始數據，各測站獨立訓練
	├── Separate_Nomorlization/      # 標準化數據，各測站獨立訓練
	├── Combine/                     # 原始數據，所有測站合併訓練
	└── Combine_Nomolization/        # 標準化數據，所有測站合併訓練
(8) 可優化部分
8.1 Rolling Stat
為何空氣品質預測需要 Rolling Stat？
-雜訊平滑
原始 AQI 與污染物濃度常因感測器誤差或瞬間排放尖峰而劇烈跳動。移動平均可提供穩定基線，減少模型學習難度。

-局部趨勢特徵
相對於單點 lag，移動均值／標準差總結了「過去 k 小時」的集體行為，幫助模型分辨「持續惡化」與「短暫波動」。

-多尺度訊息
同時計算 3 hr、24 hr、168 hr (= 7 天) 視窗，可讓模型看到不同時間階層的背景污染與季節週期。

-增強解釋性
在 SHAP 或特徵重要度圖中，rolling feature 往往能明確顯示「過去一天均值」對預測的邊際影響，利於向公衛單位解釋模型。

8.2 Diff（差分 / 變化量）
為何在空氣品質預測要用 Diff？
-偵測突增 / 突降
交通尖峰、工業排放、沙塵暴進場都會讓 PM2.5、O₃ 在「幾小時內暴衝」。
差分直接量化 斜率，模型能迅速感知劇變。

-去趨勢、讓序列近似平穩
AQI 常有季節與日夜趨勢。一階差分能剝去長期趨勢，使傳統 ML（GBDT）與 DL（LSTM）更易學習。

-補足 Lag 特徵
Lag 告訴模型「過去值」，Diff 告訴模型「變動速度」。兩者結合效果 > 任一單獨使用。

-提升解釋性
SHAP 分析可明確指出「PM2.5_diff1 = +15 µg/m³」對下一小時 AQI 提升了多少貢獻，比絕對濃度更貼近決策者關心的 變動。

8.3 「空間（多站）聚合」
將跨站訊息併入單站預測，可提供「大氣背景 + 局部偏差」的雙重視角

-背景校正: 將個別站點濃度與「同城/鄰近站平均」比較，可減少局部噪訊
-長程傳輸偵測: 當多站同步升高時，暗示區域傳輸事件

8.4 「氣象交互項」
-化學／物理耦合: 臭氧(𝑂3)生成速率與溫度、日照、NO₂ 同時影響
-傳輸與稀釋: 懸浮微粒(PM₂.₅) 在高風速時被吹散、在高濕度時吸水增重
-非線性門檻: 風向切換＋高風速才會觸發海陸風驟變

交互強度可提供解釋

8.5 「特徵選擇」
在既有特徵集合中，剔除冗餘或無效欄位，只保留對目標變數最有用的子集合。
在 AQI 專案中，經過 Lag / Rolling / 交互 / 空間聚合 後，單站特徵可以輕易破百；若再跨站展開，數量會爆增到 300–500。特徵選擇就成為必做步驟。

8.6 指標分箱: 把極端值標記成 0/1；對 LightGBM 很有效

8.7 可解釋外部資訊
衛星遙測: 捕捉高空或無測站區域的廣域污染雲
交通流量: 高流量尖峰 = 排放尖峰
排放清冊: 定位固定污染源，生成空間權重
節假日 / 活動: 行為模式改變 (放假少車、多煙火)
土地覆蓋 / NDVI: 綠覆率高區削弱臭氧前驅物


3.2 Lag 選擇
為什麼要做 Lag 分析？

揭露「時間依賴」: 污染物濃度受排放、氣象、傳輸的 累積效應，現值往往與數小時、數天前高度相關
找出「訊號 vs. 噪訊」: 透過 ACF / PACF、互信息可分辨 真正有影響 的滯後（1 h、24 h、72 h⋯）
決定滑動窗口長度: Lag 分析告訴我們「依賴在第 k 小時後衰減」，是 選窗口大小 的量化依據
對齊物理機制: 風場輸送（3 h）、日夜排放循環（24 h）、氣團滯留（48–72 h）都體現在特定滯後峰
減少資訊洩漏: 先確定最大有效 lag，再做 Rolling-origin CV，確保只用「過去」

Lag 分析＝把「過去多久的空氣還影響現在」量化清楚，讓後續特徵工程、模型設計、交叉驗證都站在正確起跑線。

(1)資料基礎建設
3,268,800 筆逐時資料，先補缺、對齊連續時間軸。
確保任何滯後計算不會跨越缺口或錯位。

(2)STL 分解 → 純化訊號
去掉 長期趨勢 + 季節性循環，對 殘差 做相關分析 ⇒ 避免趨勢把相關係數撐高。

修正程式錯誤：stl_decomp$time.series[, "remainder"].

(3)相關性偵測 (ACF / PACF)
原始 PACF 截尾 50 h；殘差 PACF 截尾 52 h → 初步鎖定分析上限。
量化「多少小時後影響趨近 0」。

(4)線性依賴：動態 Pearson 門檻
取 最高相關係數 × 5 % 當自適應門檻（0.0487）。
找到相關迅速衰退點：1 h。

(5)非線性依賴：Bias-corrected 互信息
並行跑多個 bins（5、10、15、20）驗證穩定性。
同樣在 1 h 即掉到門檻以下 → 線性、非線性依賴結論一致。

(6)產生候選滯後窗口
依 PACF + 領域知識選 24、48、52、72 h；最大 lag 統一設 120 h 以免過長。

(7)Rolling-origin 交叉驗證
每個窗口做 時間序列 CV（五折），無洩漏。
透過 RMSE/MAE 比較 → 72 h(3 d) 最佳。

結論 & 應用
短期預警：24 h 窗口就夠快、夠好。

1–3 天預測：用 72 h 窗口效果最佳（RMSE 0.316 µg/m³）。


3.3 滑動窗口介紹

3.4 模型訓練

3.5 可解釋性

4 總結分享