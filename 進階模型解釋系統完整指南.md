# 🔍 AQI 模型解釋性分析系統 - 完整進階指南

## 🎯 系統概覽

本系統提供完整的 AQI 模型解釋性分析功能，支援 LightGBM 和 LSTM 兩種模型類型的深度解釋分析。

### ✨ 核心功能特色

| 功能分類 | 基礎版 | 進階版 | 說明 |
|----------|--------|--------|------|
| **模型掃描** | ✅ | ✅ | 自動掃描 247 個訓練完成的模型 |
| **註冊表生成** | ✅ | ✅ | 生成完整的模型資訊註冊表 |
| **特徵重要度** | 🔧 | ✅ | LightGBM 原生重要度 + 視覺化 |
| **SHAP 分析** | ❌ | ✅ | 模型解釋性的黃金標準 |
| **LSTM 解釋** | ❌ | ✅ | 梯度分析 + 時間序列重要度 |
| **交互作用分析** | ❌ | ✅ | 特徵間交互效應分析 |
| **HTML 報告** | ❌ | ✅ | 互動式網頁報告 |
| **圖表生成** | 🔧 | ✅ | 高解析度可視化圖表 |

## 🚀 快速開始

### 1. 基礎使用 - 模型註冊表

```bash
# 生成所有模型的註冊表
Rscript run_model_explanation_advanced.R --analysis-type registry --verbose

# 限制分析模型數量 (測試用)
Rscript run_model_explanation_advanced.R --analysis-type registry --max-models 10 --verbose
```

### 2. 特徵重要度分析

```bash
# 基本重要度分析
Rscript run_model_explanation_advanced.R --analysis-type importance --max-models 5 --verbose

# 只分析 LightGBM 模型
Rscript run_model_explanation_advanced.R --analysis-type importance --lgbm-only --verbose

# 只分析 LSTM 模型  
Rscript run_model_explanation_advanced.R --analysis-type importance --lstm-only --verbose
```

### 3. SHAP 分析 (需要 iml 套件)

```bash
# 啟用 SHAP 分析
Rscript run_model_explanation_advanced.R --analysis-type shap --enable-shap --max-models 3 --verbose

# SHAP + HTML 報告
Rscript run_model_explanation_advanced.R --analysis-type shap --enable-shap --enable-html --verbose
```

### 4. 完整進階分析

```bash
# 完整分析流程
Rscript run_model_explanation_advanced.R --analysis-type full --enable-html --max-models 10 --verbose

# 完整分析 + SHAP (如果套件可用)
Rscript run_model_explanation_advanced.R --analysis-type full --enable-shap --enable-html --verbose
```

## 📦 套件依賴與功能對應

### 核心套件 (必需)
- `data.table`: 資料處理
- `optparse`: 命令列參數解析

### 基礎分析套件
- `ggplot2`: 基礎圖表生成
- `lightgbm`: LightGBM 模型支援
- `torch`: LSTM 模型支援

### 進階分析套件
- `iml`: SHAP 值計算和模型解釋
- `DALEX`: 替代解釋性分析套件
- `plotly`: 互動式圖表

### HTML 報告套件
- `htmlwidgets`: HTML 組件
- `DT`: 互動式資料表
- `patchwork`: 圖表組合

### 圖表增強套件
- `gridExtra`: 多圖表佈局
- `patchwork`: 進階圖表組合

## 🎯 分析類型詳解

### 1. Registry 模式
**功能**: 掃描所有模型，生成完整註冊表
**輸出**: 
- `model_registry.tsv`: 包含模型ID、類型、性能指標等
- 模型統計摘要

**使用場景**: 快速了解所有模型的基本資訊

### 2. Importance 模式  
**功能**: 特徵重要度分析和視覺化
**LightGBM輸出**:
- `importance_*.png`: 重要度柱狀圖
- `importance_summary_*.csv`: 重要度數據

**LSTM輸出**:
- 梯度重要度分析
- 時間步貢獻分析

**使用場景**: 了解哪些特徵對預測最重要

### 3. SHAP 模式
**功能**: 基於 SHAP 的模型解釋
**輸出**:
- `shap_*.csv`: SHAP 值詳細數據
- `interactions_*.csv`: 特徵交互作用分析
- 可解釋性圖表

**使用場景**: 理解模型決策過程，特徵貢獻度

### 4. Full 模式
**功能**: 執行所有可用的分析
**輸出**: 包含上述所有類型的完整分析結果
**使用場景**: 完整的模型解釋性評估

## 📊 輸出檔案說明

### 📋 註冊表檔案
- `model_registry.tsv`: 主要註冊表 (TSV格式)
- `model_registry.feather`: 快速讀取格式 (如果可用)

### 📈 LightGBM 分析結果
- `importance_[模型ID].png`: 特徵重要度圖表
- `importance_summary_[模型ID].csv`: 重要度數據摘要
- `shap_[模型ID].csv`: SHAP 分析結果
- `interactions_[模型ID].csv`: 特徵交互作用

### 🧠 LSTM 分析結果
- LSTM 梯度重要度分析結果
- 時間序列特徵貢獻分析
- 注意力權重分析 (如果模型支援)

### 📄 報告檔案
- `explanation_report_advanced.html`: 完整 HTML 報告
- `explanation_report_advanced.md`: Markdown 報告 (備用)

## ⚙️ 高級配置

### 內建配置參數

```r
ADVANCED_CONFIG <- list(
  max_samples_shap = 1000,        # SHAP分析最大樣本數
  max_samples_lime = 500,         # LIME分析最大樣本數
  lstm_gradient_samples = 200,    # LSTM梯度分析樣本數
  top_features = 30,              # Top特徵數量
  plot_width = 12,                # 圖表寬度
  plot_height = 8,                # 圖表高度
  chunk_size = 500,               # 批次處理大小
  max_ram_gb = 16                 # 最大RAM使用量
)
```

### 自訂輸出目錄

```bash
# 指定自訂的輸出目錄
Rscript run_model_explanation_advanced.R \
  --models-dir "model_outputs/models/" \
  --output-dir "results/custom_explain/" \
  --analysis-type full \
  --enable-html \
  --verbose
```

## 🔧 故障排除

### 常見問題與解決方案

1. **套件缺失警告**
   ```
   ⚠️ 缺失: patchwork, DALEX, iml
   ```
   **解決**: 安裝缺失套件或使用基礎功能

2. **SHAP 分析失敗**
   ```
   ❌ SHAP分析需要進階模組
   ```
   **解決**: 確保 `--enable-shap` 參數並安裝 `iml` 套件

3. **LSTM 分析跳過**
   ```
   ⚠️ torch套件未載入，跳過LSTM分析
   ```
   **解決**: 確保 `torch` 套件正確安裝和載入

4. **HTML 報告降級**
   ```
   ⚠️ HTML報告需要套件: DT, htmlwidgets, plotly
   ```
   **解決**: 安裝所需套件或使用 Markdown 報告

### 記憶體優化

```bash
# 對於大量模型，限制分析數量
Rscript run_model_explanation_advanced.R \
  --analysis-type importance \
  --max-models 20 \
  --verbose

# 只分析特定類型模型
Rscript run_model_explanation_advanced.R \
  --analysis-type importance \
  --lgbm-only \
  --verbose
```

## 📈 性能基準

基於當前環境的性能預估：

| 分析類型 | 10個模型 | 50個模型 | 247個模型 |
|----------|----------|----------|-----------|
| Registry | ~30秒 | ~2分鐘 | ~10分鐘 |
| Importance | ~2分鐘 | ~8分鐘 | ~40分鐘 |
| SHAP | ~5分鐘 | ~25分鐘 | ~2小時 |
| Full | ~8分鐘 | ~30分鐘 | ~3小時 |

*註: 實際時間依據硬體配置和模型複雜度而定*

## 🎯 最佳實踐建議

### 1. 初次使用
```bash
# 先測試小量模型
Rscript run_model_explanation_advanced.R --analysis-type registry --max-models 5 --verbose
```

### 2. 漸進式分析
```bash
# 基礎分析
Rscript run_model_explanation_advanced.R --analysis-type importance --max-models 10 --verbose

# 進階分析 (如果基礎分析成功)
Rscript run_model_explanation_advanced.R --analysis-type full --enable-html --max-models 10 --verbose
```

### 3. 生產環境
```bash
# 完整分析流程
Rscript run_model_explanation_advanced.R --analysis-type full --enable-html --verbose
```

## 🔄 版本比較

| 腳本版本 | 推薦場景 | 特色功能 |
|----------|----------|----------|
| `run_model_explanation_final.R` | 基礎使用、穩定性優先 | 無依賴、快速執行 |
| `run_model_explanation_advanced.R` | 完整分析、功能完整 | SHAP、LSTM、HTML |

## 🎉 總結

AQI 進階模型解釋系統提供了從基礎模型掃描到深度解釋性分析的完整功能。
無論是快速的模型概覽還是詳細的 SHAP 分析，都能滿足不同層次的分析需求。

**開始使用**:
```bash
Rscript run_model_explanation_advanced.R --help
```

**完整測試**:
```bash
Rscript run_model_explanation_advanced.R --analysis-type full --max-models 5 --enable-html --verbose
``` 